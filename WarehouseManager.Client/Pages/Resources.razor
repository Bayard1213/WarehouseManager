@page "/resources"

@inject HttpClient Http
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject ModalFormService ModalFormService

@using WarehouseManager.Shared.Dtos.Resource
@using WarehouseManager.Shared.Api
@using WarehouseManager.Shared.Enums
@using WarehouseManager.Client.Layout.Modals.Resource

<PageTitle>Ресурсы</PageTitle>
<h3>Ресурсы</h3>
<UpdateResourceModal/>
<CreateResourceModal/>

<div class="mb-2">
    <div class="d-flex align-items-center">
        <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" id="archiveSwitch"
                   role="switch" @bind="isArchive" @bind:after="LoadResources" />
        </div>
        <label class="form-check-label ms-2" for="archiveSwitch">Архив</label>

        <button class="btn btn-primary ms-3" @onclick="CreateResource">Добавить</button>
    </div>
</div>


@if (isLoading)
{
    <p><em>Загрузка...</em></p>
}
else if (resources is not null && resources.Any())
{
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Имя</th>
                <th>Статус</th>
                <th>Действие</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var resource in resources)
            {
                <tr>
                    <td>@resource.Name</td>
                    <td class="d-flex align-items-center justify-content-between">
                        <span>@GetStatusText(resource.Status)</span>
                        @if (isArchive)
                        {
                            <button class="btn btn-success btn-sm"
                                    @onclick="() => ChangeResourceStatus(resource.Id, false)">
                                <i class="bi bi-arrow-counterclockwise"></i> Восстановить
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-secondary btn-sm"
                                    @onclick="() => ChangeResourceStatus(resource.Id, true)">
                                <i class="bi bi-archive"></i> В архив
                            </button>
                        }
                    </td>
                    <td class="align-items-center justify-content-end">
                        <button class="btn btn-primary btn-sm me-1" @onclick="() => UpdateResource(resource)" title="Редактировать">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" @onclick="() => DeleteResource(resource.Id)" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>Нет данных</p>
}


@code {
    private List<ResourceDto>? resources;
    private bool isArchive = false;
    private bool isLoading = false;



    protected override async Task OnInitializedAsync()
    {
        await LoadResources();
    }

    private async Task LoadResources()
    {
        isLoading = true;
        try
        {
            var response = await Http.GetFromJsonAsync<ApiResponse<List<ResourceDto>>>(
                $"api/Resource?isActive={!isArchive}");
            resources = response?.Data ?? new();
        }
        catch (Exception ex)
        {
            NotificationService.Show($"Ошибка загрузки клиентов: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
        StateHasChanged();
    }

    private void CreateResource()
    {
        ModalFormService.Open<CreateResourceDto>(
            "Добавить ресурс",
            async (dto) =>
            {
                var resp = await Http.PostAsJsonAsync("api/Resource", dto);
                var apiResp = await resp.Content.ReadFromJsonAsync<ApiResponse<ResourceDto>>();

                NotificationService.Show(apiResp?.Message ?? "Неизвестная ошибка", apiResp?.Success ?? false);

                if (apiResp?.Success == true)
                {
                    NotificationService.Show(apiResp?.Message ?? "Ресурс успешно добавлен", apiResp?.Success ?? true);

                    await LoadResources();
                }
            });
    }

    private void UpdateResource(ResourceDto resource)
    {
        var model = new UpdateResourceDto
        {
            Name = resource.Name,
            Status = resource.Status
        };

        ModalFormService.Open<UpdateResourceDto>(
               "Редактирование ресурса",
               async (dto) =>
               {
                   var resp = await Http.PutAsJsonAsync($"api/Resource/{resource.Id}", dto);
                   var apiResp = await resp.Content.ReadFromJsonAsync<ApiResponse<ResourceDto>>();

                   NotificationService.Show(apiResp?.Message ?? "Неизвестная ошибка", apiResp?.Success ?? false);

                   if (apiResp?.Success == true)
                   {
                       NotificationService.Show(apiResp?.Message ?? "Ресурс успешно обновлён", apiResp?.Success ?? true);
                       await LoadResources();
                   }
               },
               model
        );
    }

    private async Task DeleteResource(int id)
    {
        var resp = await Http.DeleteAsync($"api/Resource/{id}");
        var apiResp = await resp.Content.ReadFromJsonAsync<ApiResponse>();
        NotificationService.Show(apiResp?.Message ?? "Ошибка удаления ресурса", apiResp?.Success ?? false);

        if (apiResp?.Success == true)
            await LoadResources();
    }

    private async Task ChangeResourceStatus(int id, bool toArchive)
    {
        try
        {
            HttpResponseMessage resp;

            if (toArchive)
            {
                resp = await Http.PatchAsJsonAsync($"api/Resource/{id}/archive", new { });
            }
            else
            {
                resp = await Http.PatchAsJsonAsync($"api/Resource/{id}/unarchive", new { });
            }

            var apiResp = await resp.Content.ReadFromJsonAsync<ApiResponse<object>>();

            NotificationService.Show(apiResp?.Message ?? "Операция выполнена", apiResp?.Success ?? false);

            if (apiResp?.Success == true)
            {
                await LoadResources();
            }
        }
        catch (Exception ex)
        {
            NotificationService.Show($"Ошибка изменения статуса: {ex.Message}", false);
        }
    }

    private Task ShowMessage(string message)
    {
        Console.WriteLine(message);
        return Task.CompletedTask;
    }
    private string GetStatusText(EntityStatus status)
    {
        return status switch
        {
            EntityStatus.Active => "Активно",
            EntityStatus.Archived => "Архивировано",
            _ => status.ToString()
        };
    }
}

